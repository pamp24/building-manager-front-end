<div class="table-responsive">
  <!-- === Toolbar: Search + Page Size === -->
  <div class="d-flex align-items-center justify-content-between p-3">
    <div class="dataTable-dropdown">
      <select
        class="form-select"
        title="select item per page"
        style="width: auto"
        name="pageSize"
        [(ngModel)]="pageSize"
        (ngModelChange)="applyFilters()"
      >
        <option [ngValue]="5">5 εγγραφές ανά σελίδα</option>
        <option [ngValue]="10">10 εγγραφές ανά σελίδα</option>
        <option [ngValue]="15">15 εγγραφές ανά σελίδα</option>
      </select>
    </div>

    <div class="dataTable-search d-flex align-items-center">
      <input
        id="table-complete-search"
        type="text"
        class="form-control"
        name="searchTerm"
        [(ngModel)]="searchTerm"
        (ngModelChange)="onSearchChange()"
        placeholder="Αναζήτηση..."
      />
    </div>
  </div>

  <!-- === Spinner κύριου πίνακα === -->
  <div *ngIf="loading" class="text-center my-3">
    <div class="spinner-border text-primary" role="status"></div>
  </div>

  <!-- === Main Table === -->
  <table class="table table-hover mb-0" *ngIf="!loading">
    <thead>
      <tr>
        <th (click)="onSort('code')" style="cursor: pointer">ID Παραστατικού {{ getSortIcon('code') }}</th>
        <th (click)="onSort('month')" style="cursor: pointer">Μήνας/Έτος {{ getSortIcon('month') }}</th>
        <th (click)="onSort('startDate')" style="cursor: pointer">Ημ. Δημιουργίας {{ getSortIcon('startDate') }}</th>
        <th (click)="onSort('endDate')" style="cursor: pointer">Ημ. Λήξης {{ getSortIcon('endDate') }}</th>
        <th (click)="onSort('total')" style="cursor: pointer">Ποσό {{ getSortIcon('total') }}</th>
        <th (click)="onSort('status')" style="cursor: pointer">Κατάσταση {{ getSortIcon('status') }}</th>
        <th class="text-center">Ενέργειες</th>
      </tr>
    </thead>
    <tbody>
      @for (s of filteredStatements; track s; let i = $index) {
        <tr>
          <td>{{ s.code }}</td>
          <td>{{ s.month }}</td>
          <td>{{ s.startDate | date: 'dd/MM/yyyy' }}</td>
          <td>{{ s.endDate | date: 'dd/MM/yyyy' }}</td>
          <td>{{ s.total | number: '1.2-2' }} €</td>
          <td>
            <span
              class="badge px-3 py-2"
              [ngClass]="{
                'bg-success': s.status === 'PAID' || s.isPaid,
                'bg-warning text-dark': s.status === 'ISSUED',
                'bg-danger': s.status === 'CLOSED',
                'bg-info': s.status === 'DRAFT',
                'bg-secondary': s.status === 'EXPIRED'
              }"
            >
              {{ translateStatus(s.status, s.isPaid) }}
            </span>
          </td>
          <td class="text-center">
            <ul class="list-inline me-auto mb-0">
              <li class="list-inline-item">
                <a href="javascript:" class="avatar avatar-xs btn-link-secondary" ngbTooltip="Προβολή" (click)="onView(s)">
                  <i class="f-16 text-secondary d-flex" antIcon type="eye" theme="outline"></i>
                </a>
              </li>
              <li class="list-inline-item">
                <a
                  href="javascript:"
                  class="avatar avatar-xs btn-link-primary"
                  [ngbTooltip]="hasAnyPayment(s) ? 'Δεν επιτρέπεται αλλαγή/διαγραφή μετά από πληρωμή' : 'Επεξεργασία'"
                  [class.disabled]="hasAnyPayment(s)"
                  (click)="hasAnyPayment(s) ? $event.preventDefault() : onEdit(s)"
                >
                  <i class="f-16 text-primary d-flex" antIcon type="edit" theme="outline"></i>
                </a>
              </li>
              <li class="list-inline-item">
                <a
                  href="javascript:"
                  class="avatar avatar-xs btn-link-danger"
                  ngbTooltip="Διαγραφή"
                  [class.disabled]="hasAnyPayment(s)"
                  [attr.aria-disabled]="hasAnyPayment(s)"
                  (click)="hasAnyPayment(s) ? $event.preventDefault() : onDelete(s)"
                >
                  <i class="f-16 text-danger d-flex" antIcon type="delete" theme="outline"></i>
                </a>
              </li>
              <li class="list-inline-item">
                <a
                  href="javascript:"
                  class="avatar avatar-xs btn-link-success"
                  ngbTooltip="Πληρωμές Χρηστών"
                  (click)="togglePayments(s.id)"
                >
                  <i
                    class="f-16 text-success d-flex"
                    antIcon
                    [type]="expandedStatementId === s.id ? 'caret-up' : 'caret-down'"
                    theme="outline"
                  ></i>
                </a>
              </li>
            </ul>
          </td>
        </tr>

        <!-- === Υποπίνακας πληρωμών === -->
        <tr *ngIf="expandedStatementId === s.id">
          <td colspan="100%">
            <div class="p-3 bg-light border rounded">
              <div *ngIf="paymentsLoading" class="text-center">
                <div class="spinner-border text-primary" role="status"></div>
              </div>

              <div *ngIf="!paymentsLoading">
                <table class="table table-sm table-striped align-middle mb-0">
                  <thead>
                    <tr>
                      <th>Χρήστης</th>
                      <th>Διαμέρισμα</th>
                      <th>Οφειλή</th>
                      <th>Πληρωμένο</th>
                      <th>Ημερομηνία</th>
                      <th>Τρόπος</th>
                      <th>Κατάσταση</th>
                      <th>Ενέργειες</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let p of statementUserPayments">
                      <td>{{ p.userLastName }} {{ p.userFirstName }}</td>
                      <td>{{ getFloorLabel(p.apartmentFloor) }}{{ p.apartmentNumber }}</td>
                      <td>{{ p.amountToPay | number: '1.2-2' }} €</td>
                      <td>{{ p.paidAmount | number: '1.2-2' }} €</td>
                      <td>{{ p.paidDate ? (p.paidDate | date: 'dd/MM/yyyy HH:mm') : '-' }}</td>
                      <td>{{ translatePaymentMethod(p.paymentMethod) || '-' }}</td>
                      <td>
                        <span
                          class="badge px-3 py-2"
                          [ngClass]="{
                            'bg-success': p.status === 'PAID',
                            'bg-warning text-dark': p.status === 'PENDING',
                            'bg-info': p.status === 'PARTIALLY_PAID'
                          }"
                        >
                          {{ translateStatus(p.status) }}
                        </span>
                      </td>
                      <td>
                        <a
                          href="javascript:"
                          class="avatar avatar-xs"
                          [ngClass]="{
                            'btn-link-primary': p.status !== 'PAID',
                            'btn-link-secondary disabled': p.status === 'PAID'
                          }"
                          ngbTooltip="{{ p.status === 'PAID' ? 'Έχει εξοφληθεί' : 'Επεξεργασία' }}"
                          (click)="p.status !== 'PAID' && onEditUser(p)"
                        >
                          <i
                            class="f-16 d-flex"
                            [ngClass]="{
                              'text-primary': p.status !== 'PAID',
                              'text-muted': p.status === 'PAID'
                            }"
                            antIcon
                            type="edit"
                            theme="outline"
                          ></i>
                        </a>
                      </td>
                    </tr>
                    <tr *ngIf="!statementUserPayments.length && !paymentsLoading">
                      <td colspan="8" class="text-center text-muted">Δεν υπάρχουν δεδομένα χρηστών για αυτό το παραστατικό</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </td>
        </tr>
      }
    </tbody>
  </table>

  <!-- === Pagination Info === -->
  <div class="p-3 d-sm-flex align-items-center justify-content-between" *ngIf="!loading">
    <div class="datatable-info">
      Δείχνει {{ (page - 1) * pageSize + 1 }} έως {{ Math.min(page * pageSize, total) }} από {{ total }} εγγραφές
    </div>
    <ngb-pagination
      [collectionSize]="total"
      [(page)]="page"
      [pageSize]="pageSize"
      (pageChange)="onPageChange($event)"
      class="table-pagination"
    ></ngb-pagination>
  </div>
</div>
