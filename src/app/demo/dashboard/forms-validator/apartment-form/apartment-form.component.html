<form [formGroup]="form" (ngSubmit)="onFinish()">
  <div formArrayName="apartments">
    <div *ngFor="let group of apartments.controls; let i = index" [formGroupName]="i" class="card shadow-sm mb-4">
      <div class="card-header bg-light d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Διαμέρισμα {{ i + 1 }}</h5>
        <button *ngIf="apartments.length > 1" type="button" class="btn btn-sm btn-outline-danger" (click)="removeApartment(i)">
          <i class="bi bi-trash"></i>
          Αφαίρεση
        </button>
      </div>

      <div class="card-body">
        <div class="row g-3">
          <!-- Ονομα Ιδιοκτήτη -->
          <div class="col-md-4">
            <label class="form-label">Όνομα Ιδιοκτήτη</label>
            <input class="form-control" formControlName="ownerFirstName" [readonly]="group.get('isManagerHouse')?.value" />
          </div>
          <div class="col-md-4">
            <label class="form-label">Επώνυμο Ιδιοκτήτη</label>
            <input class="form-control" formControlName="ownerLastName" [readonly]="group.get('isManagerHouse')?.value" />
          </div>

          <!-- Ενοικιάζεται -->
          <div class="col-md-4">
            <label class="form-label">Ενοικιάζεται;</label>
            <select class="form-select" formControlName="isRented">
              <option [ngValue]="null">Επιλέξτε</option>
              <option [ngValue]="true">Ναι</option>
              <option [ngValue]="false">Όχι</option>
            </select>
          </div>

          <!-- Ενοικιαστής -->
          <ng-container *ngIf="group.get('isRented')?.value === true">
            <div class="col-md-4">
              <label class="form-label">Όνομα Ενοικιαστή</label>
              <input class="form-control" formControlName="residentFirstName" />
            </div>
            <div class="col-md-4">
              <label class="form-label">Επώνυμο Ενοικιαστή</label>
              <input class="form-control" formControlName="residentLastName" />
            </div>
          </ng-container>

          <!-- Αριθμός / Όροφος / Τμ -->
          <div class="col-md-4">
            <label class="form-label">Αριθμός Διαμερίσματος</label>
            <input class="form-control" formControlName="apartmentNumber" />
          </div>
          <div class="col-md-4">
            <label class="form-label">Όροφος</label>
            <select class="form-select" formControlName="floor">
              <option value="">Επιλέξτε</option>

              <option *ngFor="let f of floorOptions; trackBy: trackByFloor" [value]="f">
                {{ f }}
              </option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Τετραγωνικά Μέτρα</label>
            <input class="form-control" type="number" formControlName="sqMetersApart" />
          </div>

          <!-- Parking -->
          <div class="col-md-4">
            <label class="form-label">Διαθέτει Parking</label>
            <select class="form-select" formControlName="hasParking">
              <option [ngValue]="null">Επιλέξτε</option>
              <option [ngValue]="true">Ναι</option>
              <option [ngValue]="false">Όχι</option>
            </select>
          </div>
          <ng-container *ngIf="group.get('hasParking')?.value === true">
            <div class="col-md-4">
              <label class="form-label">Αριθμός Θέσης Parking</label>
              <input class="form-control" formControlName="parkingSlot" />
            </div>
          </ng-container>

          <!-- Χιλιοστά -->
          <div class="col-md-4">
            <label class="form-label">Χιλιοστά Κοινοχρήστων</label>
            <input type="number" class="form-control" formControlName="commonPercent" />
          </div>
          <div class="col-md-4">
            <label class="form-label">Χιλιοστά Ασανσέρ</label>
            <input type="number" class="form-control" formControlName="elevatorPercent" />
          </div>
          <div class="col-md-4">
            <label class="form-label">Χιλιοστά Θέρμανσης</label>
            <input type="number" class="form-control" formControlName="heatingPercent" />
          </div>
        </div>

        <!-- Αποθήκη -->
        <div class="row mt-3">
          <div class="col-md-4" *ngIf="storageLimit > 0">
            <div class="form-check">
              <input
                type="checkbox"
                class="form-check-input"
                formControlName="hasStorage"
                [disabled]="!group.get('hasStorage')?.value && currentUsedStorages >= storageLimit"
              />
              <label class="form-check-label">Διαθέτει Αποθήκη</label>
            </div>
            <small class="text-danger" *ngIf="!group.get('hasStorage')?.value && currentUsedStorages >= storageLimit">
              Το όριο αποθηκών έχει καλυφθεί.
            </small>
          </div>
          <ng-container *ngIf="group.get('hasStorage')?.value">
            <div class="col-md-4">
              <label class="form-label">Αριθμός Αποθήκης</label>
              <input class="form-control" formControlName="storageSlot" />
            </div>
          </ng-container>
        </div>

        <!-- Διαμέρισμα Διαχειριστή -->
        <ng-container *ngIf="managerHouseExist">
          <div class="col-md-4 mt-3">
            <div class="form-check">
              <input type="checkbox" class="form-check-input" formControlName="isManagerHouse" />
              <label class="form-check-label">Διαμέρισμα Διαχειριστή</label>
            </div>
          </div>
        </ng-container>
      </div>
    </div>
  </div>

  <!-- Κουμπιά -->
  <div class="d-flex justify-content-end gap-2 mt-4">
    <button type="button" class="btn btn-secondary" (click)="onBack()">Άκυρο</button>
    <button type="button" class="btn btn-outline-primary" (click)="addApartment()">
      <i class="bi bi-plus-circle"></i>
      Προσθήκη Διαμερίσματος
    </button>
    <button type="submit" class="btn btn-success">
      <i class="bi bi-check-circle"></i>
      Ολοκλήρωση
    </button>
  </div>
</form>
